# å¼€å‘è‡ªåŠ¨åŒ–å·¥å…·é›†

.PHONY: help check test fmt lint fix build clean install-hooks

# é»˜è®¤ç›®æ ‡
help:
	@echo "ğŸ› ï¸  æ—¥çœå½• - å¼€å‘å·¥å…·"
	@echo ""
	@echo "å¸¸ç”¨å‘½ä»¤:"
	@echo "  make check        - è¿è¡Œæ‰€æœ‰æ£€æŸ¥ï¼ˆæ¨è commit å‰ä½¿ç”¨ï¼‰"
	@echo "  make test         - è¿è¡Œæµ‹è¯•"
	@echo "  make fmt          - æ ¼å¼åŒ–ä»£ç "
	@echo "  make lint         - è¿è¡Œ linter"
	@echo "  make fix          - è‡ªåŠ¨ä¿®å¤é—®é¢˜"
	@echo "  make build        - ç¼–è¯‘é¡¹ç›®"
	@echo "  make install-hooks - å®‰è£… Git hooks"
	@echo ""
	@echo "Android ç›¸å…³:"
	@echo "  make android      - æ„å»º Android åº“"
	@echo "  make apk          - æ„å»º APK"
	@echo ""

# å®Œæ•´æ£€æŸ¥ï¼ˆç­‰åŒäº CIï¼‰
check: fmt lint test
	@echo "âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼"

# è¿è¡Œæµ‹è¯•
test:
	@echo "ğŸ§ª è¿è¡Œæµ‹è¯•..."
	@cargo test --quiet

# æ ¼å¼åŒ–ä»£ç 
fmt:
	@echo "ğŸ“ æ ¼å¼åŒ–ä»£ç ..."
	@cargo fmt --all

# è¿è¡Œ Clippy
lint:
	@echo "ğŸ” è¿è¡Œ Clippy..."
	@cargo clippy --all-targets --all-features -- \
		-D warnings \
		-W clippy::all \
		-W clippy::pedantic \
		-A clippy::missing_errors_doc \
		-A clippy::missing_panics_doc

# è‡ªåŠ¨ä¿®å¤é—®é¢˜
fix:
	@echo "ğŸ”§ è‡ªåŠ¨ä¿®å¤é—®é¢˜..."
	@cargo fmt --all
	@cargo clippy --fix --allow-dirty --allow-staged
	@echo "âœ… å·²å°è¯•è‡ªåŠ¨ä¿®å¤"

# ç¼–è¯‘
build:
	@echo "ğŸ”¨ ç¼–è¯‘é¡¹ç›®..."
	@cargo build

# ç¼–è¯‘ release ç‰ˆæœ¬
build-release:
	@echo "ğŸ”¨ ç¼–è¯‘ release ç‰ˆæœ¬..."
	@cargo build --release --features server

# æ¸…ç†
clean:
	@echo "ğŸ§¹ æ¸…ç†æ„å»ºæ–‡ä»¶..."
	@cargo clean
	@rm -rf android/app/build
	@rm -rf android/app/src/main/jniLibs

# å®‰è£… Git hooks
install-hooks:
	@bash scripts/setup-hooks.sh

# è¿è¡Œå¼€å‘æœåŠ¡å™¨
dev:
	@echo "ğŸš€ å¯åŠ¨å¼€å‘æœåŠ¡å™¨..."
	@RUST_LOG=debug cargo run --features server

# è¿è¡Œç³»ç»Ÿæµ‹è¯•
system-test:
	@echo "ğŸ”§ è¿è¡Œç³»ç»Ÿæµ‹è¯•..."
	@bash scripts/system_test.sh

# å‹åŠ›æµ‹è¯•
stress-test:
	@echo "âš¡ è¿è¡Œå‹åŠ›æµ‹è¯•..."
	@REQUESTS=200 CONCURRENCY=20 bash scripts/stress_test.sh

# Android æ„å»º
android:
	@echo "ğŸ“± æ„å»º Android åº“..."
	@cargo build --target aarch64-linux-android --release --lib
	@cargo build --target armv7-linux-androideabi --release --lib
	@bash scripts/sync_android_assets.sh

# æ„å»º APK
apk: android
	@echo "ğŸ“¦ æ„å»º APK..."
	@cd android && ./gradlew assembleRelease
	@echo "âœ… APK: android/app/build/outputs/apk/release/app-release.apk"

# å®‰è£…åˆ°è®¾å¤‡
install-apk: apk
	@echo "ğŸ“² å®‰è£…åˆ°è®¾å¤‡..."
	@adb install -r android/app/build/outputs/apk/release/app-release.apk

# ä»£ç è¦†ç›–ç‡
coverage:
	@echo "ğŸ“Š ç”Ÿæˆä»£ç è¦†ç›–ç‡æŠ¥å‘Š..."
	@cargo tarpaulin --out Html --output-dir coverage
	@echo "âœ… æŠ¥å‘Š: coverage/index.html"

# å®‰å…¨å®¡è®¡
audit:
	@echo "ğŸ”’ è¿è¡Œå®‰å…¨å®¡è®¡..."
	@cargo audit

# æ›´æ–°ä¾èµ–
update:
	@echo "â¬†ï¸  æ›´æ–°ä¾èµ–..."
	@cargo update
	@cargo audit

# ç”Ÿæˆæ–‡æ¡£
docs:
	@echo "ğŸ“š ç”Ÿæˆæ–‡æ¡£..."
	@cargo doc --no-deps --open

# å…¨é‡æ£€æŸ¥ï¼ˆåŒ…æ‹¬æµ‹è¯•ã€å®¡è®¡ã€è¦†ç›–ç‡ï¼‰
full-check: check audit coverage
	@echo "âœ… å…¨é‡æ£€æŸ¥å®Œæˆï¼"

# å¿«é€Ÿæ£€æŸ¥ï¼ˆåªæ£€æŸ¥æ ¼å¼å’Œ lintï¼Œä¸è¿è¡Œæµ‹è¯•ï¼‰
quick-check: fmt lint
	@echo "âš¡ å¿«é€Ÿæ£€æŸ¥å®Œæˆï¼"

# ç›‘å¬æ–‡ä»¶å˜åŒ–è‡ªåŠ¨è¿è¡Œæµ‹è¯•ï¼ˆéœ€è¦å®‰è£… cargo-watchï¼‰
watch:
	@command -v cargo-watch >/dev/null 2>&1 || { echo "è¯·å…ˆå®‰è£…: cargo install cargo-watch"; exit 1; }
	@echo "ğŸ‘€ ç›‘å¬æ–‡ä»¶å˜åŒ–..."
	@cargo watch -x test

# Benchmark
bench:
	@echo "ğŸ“ˆ è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•..."
	@cargo bench

# ä¸€é”®å‘å¸ƒæµç¨‹
release: full-check build-release apk
	@echo "ğŸ‰ å‡†å¤‡å‘å¸ƒï¼"
	@echo "  - Web æœåŠ¡å™¨: target/release/daily-reckoning"
	@echo "  - Android APK: android/app/build/outputs/apk/release/app-release.apk"
