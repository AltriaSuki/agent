#!/bin/bash
# è‡ªåŠ¨åŒ–ä»£ç æ£€æŸ¥ - åœ¨ commit å‰è¿è¡Œ

set -e

echo "ğŸ” è¿è¡Œè‡ªåŠ¨åŒ–æ£€æŸ¥..."

# 1. Rust æ ¼å¼åŒ–æ£€æŸ¥
echo "ğŸ“ æ£€æŸ¥ Rust ä»£ç æ ¼å¼..."
cargo fmt --all -- --check || {
    echo "âŒ ä»£ç æ ¼å¼ä¸è§„èŒƒï¼Œæ­£åœ¨è‡ªåŠ¨ä¿®å¤..."
    cargo fmt --all
    echo "âœ… å·²è‡ªåŠ¨æ ¼å¼åŒ–ï¼Œè¯·é‡æ–° add æ–‡ä»¶"
    exit 1
}

# 2. Clippy ä»£ç è´¨é‡æ£€æŸ¥
echo "ğŸ” è¿è¡Œ Clippy ä»£ç æ£€æŸ¥..."
cargo clippy --all-targets --all-features -- \
    -D warnings \
    -W clippy::all \
    -W clippy::pedantic \
    -A clippy::missing_errors_doc \
    -A clippy::missing_panics_doc || {
    echo "âŒ Clippy å‘ç°é—®é¢˜ï¼Œè¯·ä¿®å¤åå†æäº¤"
    exit 1
}

# 3. è¿è¡Œæµ‹è¯•
echo "ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•..."
cargo test --quiet || {
    echo "âŒ æµ‹è¯•å¤±è´¥ï¼Œè¯·ä¿®å¤åå†æäº¤"
    exit 1
}

# 4. æ£€æŸ¥å‰ç«¯ä»£ç ï¼ˆå¦‚æœæœ‰ä¿®æ”¹ï¼‰
if git diff --cached --name-only | grep -q "^static/.*\.js$"; then
    echo "ğŸŒ æ£€æŸ¥å‰ç«¯ä»£ç ..."

    # æ£€æŸ¥ JavaScript è¯­æ³•é”™è¯¯
    for file in $(git diff --cached --name-only | grep "\.js$"); do
        if [ -f "$file" ]; then
            node -c "$file" || {
                echo "âŒ JavaScript è¯­æ³•é”™è¯¯: $file"
                exit 1
            }
        fi
    done
fi

# 5. æ£€æŸ¥æ˜¯å¦æœ‰ TODO æˆ– FIXMEï¼ˆè­¦å‘Šï¼Œä¸é˜»æ­¢æäº¤ï¼‰
echo "ğŸ“‹ æ£€æŸ¥å¾…åŠäº‹é¡¹..."
git diff --cached | grep -E "^\+.*TODO|^\+.*FIXME" && {
    echo "âš ï¸  è­¦å‘Š: æäº¤ä¸­åŒ…å« TODO/FIXME"
} || true

# 6. æ£€æŸ¥æ•æ„Ÿä¿¡æ¯
echo "ğŸ”’ æ£€æŸ¥æ•æ„Ÿä¿¡æ¯..."
git diff --cached | grep -iE "password|secret|api_key|token" && {
    echo "âŒ è­¦å‘Š: å¯èƒ½åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼"
    echo "è¯·ç¡®è®¤è¿™äº›ä¸æ˜¯çœŸå®çš„å¯†é’¥"
    read -p "ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ(y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
} || true

echo "âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼"
