# Claude Code 自动化代码审查工作流

> 利用 Claude Code 的 Agent 系统，实现自动化的"编码 + 审查"流程

## 🎯 核心理念

利用 Claude Code 的 **Task tool**，可以并行或串行运行多个 agent，每个 agent 负责不同的任务：
- **Sonnet agent**: 快速编码实现
- **Opus agent**: 深度代码审查
- **专门的测试 agent**: 运行测试和验证

## 📋 使用方法

### 方法 1: 直接在 Claude Code 中使用（最简单）

在 Claude Code 对话中，直接说：

```
帮我实现 XXX 功能，完成后自动进行代码审查。

要求：
1. 先用 Sonnet 实现功能
2. 实现完成后，自动启动 Opus agent 进行代码审查
3. 如果有严重问题，自动修复
4. 生成最终报告
```

Claude 会自动：
1. 使用 Task tool 启动一个 general-purpose agent (Sonnet) 实现功能
2. 实现完成后，自动启动另一个 agent (Opus) 进行审查
3. 根据审查结果，决定是否需要修复

### 方法 2: 自定义提示模板

将以下内容保存为项目根目录的 `.claude-workflow` 文件：

```markdown
# 自动化工作流配置

## 阶段 1: 实现 (Sonnet)
- 分析需求
- 实现功能
- 编写基础测试
- 生成 IMPLEMENTATION.md

## 阶段 2: 审查 (Opus)
- 代码质量检查
- 架构审查
- 安全审查
- 生成 CODE_REVIEW.md

## 阶段 3: 修复 (Sonnet)
- 根据审查意见修复 Critical 和 Major 问题
- 更新测试
- 生成 FIXES.md
```

然后在 Claude Code 中：
```
按照 .claude-workflow 文件执行完整的开发流程，实现：[你的需求]
```

## 💡 高级用法

### 并行运行多个审查维度

```
请帮我实现用户认证功能。完成后，请并行运行以下审查：

1. 安全审查 agent (Opus) - 检查安全漏洞
2. 性能审查 agent (Sonnet) - 分析性能问题
3. 测试审查 agent (Sonnet) - 检查测试覆盖率

并行运行这些 agents，然后汇总所有审查意见。
```

Claude 会使用一个消息发送多个 Task tool 调用，并行运行审查。

### 渐进式开发

```
我要实现一个复杂的功能，请分阶段进行：

Phase 1: 核心功能实现 (Sonnet)
- 实现完成后自动审查 (Opus)
- 修复问题后再继续

Phase 2: 添加高级功能 (Sonnet)
- 实现完成后自动审查 (Opus)
- 修复问题后再继续

Phase 3: 性能优化 (Sonnet)
- 优化完成后进行性能审查 (Opus)

每个阶段完成后暂停，等待我确认再继续下一阶段。
```

## 🔧 技术原理

### Agent 串联执行

```
用户输入: "实现功能 X"
    ↓
Claude (Sonnet 4.5) 计划
    ↓
启动 Task tool (general-purpose agent, model=sonnet)
    ↓
[Agent 1 执行] 实现功能，生成 IMPLEMENTATION.md
    ↓
[Agent 1 返回结果]
    ↓
Claude 分析实现结果
    ↓
启动 Task tool (general-purpose agent, model=opus)
    ↓
[Agent 2 执行] 审查代码，生成 CODE_REVIEW.md
    ↓
[Agent 2 返回结果]
    ↓
Claude 分析审查结果
    ↓
如果有严重问题，启动 Task tool (model=sonnet)
    ↓
[Agent 3 执行] 修复问题
    ↓
完成
```

### Agent 并行执行

```
用户输入: "并行审查"
    ↓
Claude 在一个消息中发送多个 Task tool 调用
    ↓
┌─────────────┬──────────────┬──────────────┐
│  Agent 1    │   Agent 2    │   Agent 3    │
│  (安全审查)  │  (性能审查)   │  (测试审查)   │
└─────────────┴──────────────┴──────────────┘
    ↓ (并行执行)
所有 agents 完成后，Claude 汇总结果
```

## 📝 示例对话

### 示例 1: 基础自动化

**你:**
```
实现一个 Markdown 解析器，实现后自动用 Opus 审查代码质量。
```

**Claude 的执行流程:**
1. 启动 Sonnet agent 实现解析器
2. Sonnet agent 完成并返回实现代码
3. 自动启动 Opus agent 审查
4. Opus agent 返回审查意见
5. 向你展示实现和审查结果
6. 如果有问题，询问是否需要修复

### 示例 2: 完全自动化

**你:**
```
实现一个用户认证系统，包括：
1. JWT token 生成
2. 密码哈希
3. 登录/注销 API

要求全自动流程：
- Sonnet 实现
- Opus 审查
- 如果有 Critical 或 Major 问题，自动用 Sonnet 修复
- 最后给我一个完整的报告
```

**Claude 的执行:**
会自动完成整个流程，只在最后给你一个总结报告。

### 示例 3: 增量审查

**你:**
```
我在开发一个 REST API。每当我写完一个 endpoint，帮我自动用 Opus 审查，并指出问题。

现在写第一个 endpoint: GET /users
```

**后续对话:**
```
写下一个: POST /users
```
Claude 会记住之前的模式，自动审查新的代码。

## 🎛️ 控制选项

### 指定模型

```
用 Haiku 快速实现原型，然后用 Opus 深度审查
```

Claude 会：
- Task tool 1: `model=haiku` - 快速实现
- Task tool 2: `model=opus` - 深度审查

### 控制审查严格程度

```
用宽松模式审查（只报告 Critical 问题）
```

或

```
用严格模式审查（报告所有问题包括代码风格）
```

## 🚀 最佳实践

### ✅ 推荐

1. **清晰的任务描述**
   ```
   实现用户登录功能，包括密码验证和 session 管理。
   完成后自动审查安全性和性能。
   ```

2. **分阶段审查**
   ```
   实现核心功能后先审查一次，确认方向正确再继续。
   ```

3. **并行审查不同维度**
   ```
   并行运行安全审查和性能审查，节省时间。
   ```

4. **保存审查记录**
   ```
   将所有审查意见保存到 docs/reviews/ 目录，便于追踪。
   ```

### ❌ 避免

1. **模糊的需求**
   ```
   ❌ "帮我优化代码"
   ✅ "优化数据库查询性能，减少 N+1 查询"
   ```

2. **跳过审查**
   - 即使是小改动，也建议快速审查

3. **过度依赖自动修复**
   - 审查意见需要人工判断优先级

## 📊 效率对比

| 传统方式 | 自动化方式 |
|---------|-----------|
| 1. 写代码（10min） | 1. 描述需求（1min） |
| 2. 手动切换到 Opus | 2. 自动实现+审查 |
| 3. 复制代码到新对话 | （无需切换） |
| 4. 等待审查（5min） | |
| 5. 手动记录问题 | 3. 查看结果（1min） |
| 6. 切回 Sonnet 修复 | |
| 7. 再次测试 | |
| **总计: ~20-30min** | **总计: ~5-10min** |

## 🔍 故障排查

### Agent 没有自动运行

确认你的提示中包含了明确的指令：
```
完成后**自动**启动审查
```

### 审查不够深入

显式要求使用 Opus：
```
用 Opus 模型进行深度审查
```

### 想看中间过程

添加要求：
```
每个阶段完成后向我报告进度
```

## 🎓 进阶技巧

### 1. 创建可复用的审查检查清单

在项目中创建 `.claude/review-checklist.md`:
```markdown
# 代码审查检查清单

## 安全
- [ ] 无 SQL 注入风险
- [ ] 无 XSS 风险
- [ ] 敏感数据已加密

## 性能
- [ ] 无 N+1 查询
- [ ] 合理使用缓存
- [ ] 数据库查询有索引

## 测试
- [ ] 单元测试覆盖 > 80%
- [ ] 边界情况有测试
- [ ] 错误处理有测试
```

然后：
```
按照 .claude/review-checklist.md 审查代码
```

### 2. 自定义审查 agent

```
创建一个专门的安全审查 agent，使用 OWASP Top 10 标准审查所有代码。
```

### 3. 集成到 Git workflow

```
每次我提交前，自动审查 git diff，确保没有明显问题再允许提交。
```

## 📚 参考

- Claude Code Agent 系统文档
- Task tool 使用说明
- Multi-agent 协作模式

---

**记住**: 这个工作流的核心是**利用 Claude Code 的原生能力**，无需安装额外工具，直接在对话中完成整个开发和审查流程！
